<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Burrito Bison</title>
    
    <base href="https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/BurritoBison-main/">
    
    <style>
        html, body {
            width: 100%; height: 100%;
            margin: 0; padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', sans-serif;
        }

        .webgl-content {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
        }

        #gameContainer {
            width: 100% !important; height: 100% !important;
        }

        canvas {
            width: 100%; height: 100%;
            display: block;
        }

        /* Loading Screen UI */
        #loader-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #0d0d0d;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bar-bg {
            width: 300px; height: 6px;
            background: #222; border-radius: 10px;
            margin-top: 20px; overflow: hidden;
        }

        #bar-fill {
            width: 0%; height: 100%;
            background: #ff4747;
            box-shadow: 0 0 15px rgba(255, 71, 71, 0.5);
            transition: width 0.2s linear;
        }

        #status-text {
            color: #777; font-size: 11px; font-weight: 600;
            letter-spacing: 4px; text-transform: uppercase; margin-top: 15px;
        }

        #percent-text {
            color: #fff; font-size: 32px; font-weight: 900;
        }
    </style>

    <script>
      // --- FIX: Unity Compatibility Layer ---
      // This prevents "JS Error" crashes when the game calls external functions
      window.UnityLoader = window.UnityLoader || {};
      window.onUnityMessage = function(msg) { console.log("Unity Msg:", msg); };
      window.Mute = function() { console.log("Mute called"); };
      window.Unmute = function() { console.log("Unmute called"); };
      
      window.fileMergerConfig = {
        files: [
          { name: 'burrito-bison-ll.data.unityweb', parts: 2 }, 
          { name: 'burrito-bison-ll.asm.code.unityweb', parts: 2 },
          { name: 'burrito-bison-ll.asm.memory.unityweb', parts: 1 },
          { name: 'burrito-bison-ll.asm.framework.unityweb', parts: 1 }
        ]
      };

      window.mergedFiles = {};
      window.unityInited = false;
      const originalFetch = window.fetch;

      // XHR Interceptor
      const originalXHR = window.XMLHttpRequest;
      window.XMLHttpRequest = function() {
        const xhr = new originalXHR();
        const open = xhr.open;
        xhr.open = function(method, url) { this._url = url.toString(); return open.apply(this, arguments); };
        const send = xhr.send;
        xhr.send = function() {
          for (const file of window.fileMergerConfig.files) {
            if (this._url && this._url.includes(file.name) && window.mergedFiles[file.name]) {
              Object.defineProperty(this, 'status', { value: 200 });
              Object.defineProperty(this, 'readyState', { value: 4 });
              Object.defineProperty(this, 'response', { value: window.mergedFiles[file.name] });
              if (this.onload) this.onload();
              if (this.onreadystatechange) this.onreadystatechange();
              return;
            }
          }
          try {
            return send.apply(this, arguments);
          } catch(e) {
            console.warn("Caught XHR error to prevent crash:", e);
          }
        };
        return xhr;
      };

      // Fetch Interceptor
      window.fetch = async function(url, ...args) {
        const urlStr = url.toString();
        for (const file of window.fileMergerConfig.files) {
          if (urlStr.includes(file.name) && window.mergedFiles[file.name]) {
            return new Response(window.mergedFiles[file.name], { status: 200 });
          }
        }
        // Handle potential Fetch errors gracefully (Save data errors)
        return originalFetch.call(this, url, ...args).catch(err => {
            console.warn("Blocked fetch error:", err);
            return new Response("", {status: 404});
        });
      };

      async function startLoading() {
        const statusText = document.getElementById('status-text');
        const percentText = document.getElementById('percent-text');
        const fill = document.getElementById('bar-fill');
        const overlay = document.getElementById('loader-overlay');
        
        let actualFinished = false;
        const duration = 20000; // Reduced to 20s for better UX
        const startTime = Date.now();

        const mergeTask = (async () => {
          const baseUrl = "https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/BurritoBison-main/";
          try {
              for (const file of window.fileMergerConfig.files) {
                const parts = [];
                for (let i = 1; i <= file.parts; i++) {
                  const res = await originalFetch(baseUrl + file.name + ".part" + i);
                  parts.push(await res.arrayBuffer());
                }
                const totalSize = parts.reduce((a, b) => a + b.byteLength, 0);
                const ui8 = new Uint8Array(totalSize);
                let offset = 0;
                for (const p of parts) { ui8.set(new Uint8Array(p), offset); offset += p.byteLength; }
                window.mergedFiles[file.name] = ui8.buffer;
              }
              actualFinished = true;
          } catch(e) { console.error("Merge error:", e); }
        })();

        const progressInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          const visualPercent = Math.min((elapsed / duration) * 100, 99);
          
          fill.style.width = visualPercent + '%';
          percentText.innerText = Math.floor(visualPercent) + "%";
          statusText.innerText = "Loading Content...";

          if (visualPercent >= 10 && !window.unityInited && actualFinished) {
            window.unityInited = true;
            initUnity();
          }

          if (actualFinished && elapsed >= duration) {
            clearInterval(progressInterval);
            fill.style.width = '100%';
            percentText.innerText = "100%";
            statusText.innerText = "Launch Ready";
            
            setTimeout(() => {
              overlay.style.opacity = '0';
              setTimeout(() => { overlay.style.display = 'none'; }, 1200);
            }, 500);
          }
        }, 100);
      }

      function initUnity() {
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/BurritoBison-main/burrito-bison-ll.js";
        script.onload = () => {
          // Explicitly handle Module errors to keep game running
          window.gameInstance = UnityLoader.instantiate("gameContainer", "https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/BurritoBison-main/burrito-bison-ll.json", {
            Module: { 
                onRuntimeInitialized: function() { console.log("Unity init complete."); },
                LogException: function(e) { console.warn("Unity internal exception caught:", e); }
            }
          });
        };
        document.head.appendChild(script);
      }
    </script>
    <script src="https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/BurritoBison-main/UnityProgress.js"></script>
</head>
<body onload="startLoading()">
    <div id="loader-overlay">
        <div id="percent-text">0%</div>
        <div class="bar-bg">
            <div id="bar-fill"></div>
        </div>
        <div id="status-text">Booting System</div>
    </div>

    <div class="webgl-content">
        <div id="gameContainer"></div>
    </div>
</body>
</html>
